<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espresso World Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-7Ih0jWzVt6jZ7b5bqz4wz5wR9V5z9zvZ9z9z9z9z9z9z9z9z9z9z9z9z9z9z" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-o9N1j7kGZb+3kG8a9kaGb0G3FScYxwZ1Z8RxtwGv7Xk=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #DE9E67 0%, #6b4a2d 100%) fixed;
            color: #e0c8a9;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
            position: relative;
        }
        
        body:before {
            content: '';
            position: fixed;
            inset: 0;
            background: radial-gradient(ellipse at center, rgba(0,0,0,0.25) 0%, rgba(0,0,0,0.6) 100%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container { z-index: 1; max-width: 1200px; width: 100%; display: flex; flex-direction: column; align-items: center; }
        
        header { text-align: center; margin-bottom: 24px; width: 100%; }
        
        h1 { font-size: 2.6rem; margin-bottom: 10px; color: #e0c8a9; text-shadow: 0 0 10px rgba(224, 200, 169, 0.5); letter-spacing: 2px; }
        .subtitle { font-size: 1.1rem; color: #b89f7e; max-width: 700px; margin: 0 auto 12px; }
        
        .top-menu {
            position: fixed;
            right: 20px;
            top: 20px;
            background: linear-gradient(135deg, #ffffff 0%, #f5efe7 70%);
            border: 1px solid #c9b29b;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: stretch;
            z-index: 3;
        }
        .top-menu .title { color: #6b4a2d; font-weight: 600; margin-right: 0; font-size: 0.9rem; }
        .top-menu select { background: #fff; border: 1px solid #c9b29b; color: #6b4a2d; border-radius: 8px; padding: 6px 8px; min-width: 200px; outline: none; font-size: 0.9rem; }
        .top-menu .badge { background: #6b4a2d; color: #fff; border-radius: 16px; padding: 3px 6px; font-size: 0.7rem; margin-left: 4px; }
        .top-menu .badge.past { background:#b58257; }
        
        .map-container { width: 100%; height: 560px; background: rgba(20,15,15,0.45); border-radius: 12px; position: relative; overflow: hidden; border: 1px solid #3a2c2c; box-shadow: 0 8px 24px rgba(0,0,0,0.4); margin-top: 24px; }
        #leafletMap { position: absolute; inset: 0; }
        .map-loading { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.35); color: #e0c8a9; z-index: 500; font-weight: 600; letter-spacing: 0.5px; }
        .map-brand { position: absolute; left: 10px; bottom: 10px; display: flex; align-items: center; gap: 6px; background: rgba(0,0,0,0.25); padding: 4px 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.08); z-index: 2; }
        .map-brand img { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; }
        .map-brand span { color: #e0c8a9; font-weight: 600; letter-spacing: 0.4px; font-size: 0.95rem; }
        
        .marker { position: absolute; width: 20px; height: 20px; transform: translate(-50%, -100%); z-index: 2; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); pointer-events: none; }
        .marker .cup { color: #eae5dd; font-size: 18px; }
        .marker.upcoming .cup { color: #ffffff; }
        .marker.past .cup { color: #d6c7b8; opacity: 0.9; }
        
        .magnifier { position: absolute; width: 110px; height: 110px; border-radius: 50%; box-shadow: 0 0 0 4px rgba(255,255,255,0.8), inset 0 0 14px rgba(0,0,0,0.3), 0 6px 14px rgba(0,0,0,0.35); z-index: 400; transform: translate(-50%, -50%); transition: left 0.25s ease, top 0.25s ease; pointer-events: none; }
        .magnifier::after { content: ''; position: absolute; inset: 0; border-radius: 50%; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.2); }
        .hand { position: absolute; width: 160px; right: -30px; bottom: -16px; z-index: 401; opacity: 0.95; pointer-events: none; }
        .hand img { width: 100%; height: auto; filter: drop-shadow(0 6px 10px rgba(0,0,0,0.5)); }
        
        .events-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px; width: 100%; margin-top: 18px; margin-bottom: 16px; }
        .event-item { background: rgba(20, 15, 15, 0.55); border: 1px solid #3a2c2c; color: #e0c8a9; border-radius: 10px; padding: 12px 14px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background .2s ease, border-color .2s ease, transform .2s ease; }
        .event-item:hover { background: rgba(184,159,126,0.15); border-color: #b89f7e; transform: translateY(-2px); }
        .event-item .tag { font-size: 0.7rem; background: rgba(184,159,126,0.25); border-radius: 12px; padding: 3px 8px; margin-left: auto; }
        .event-item.active { background: rgba(224,200,169,0.18); border-color: #e0c8a9; }
        .event-details { width: 100%; background: rgba(20,15,15,0.6); border: 1px solid #3a2c2c; border-radius: 10px; padding: 16px; color: #d0b899; display: none; }
        .event-details h3 { color: #e0c8a9; margin-bottom: 6px; }
        .event-details .date { color: #b89f7e; font-style: italic; margin-bottom: 10px; }
        
        footer { text-align: center; margin-top: auto; padding: 20px; color: #7e6559; width: 100%; }
        
        @media (max-width: 768px) {
            h1 { font-size: 2.2rem; }
            .map-container { height: 420px; }
            .magnifier { width: 120px; height: 120px; }
            .hand { width: 150px; right: -30px; bottom: -16px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Espresso World Map</h1>
            <p class="subtitle">Pick a destination from the menus â€” watch the magnifier find it.</p>
        </header>

        <div class="top-menu">
            <span class="title"><i class="fas fa-mug-hot"></i> Events</span>
            <div>
                <label for="futureSelect" class="sr-only">Future</label>
                <select id="futureSelect">
                    <option value="">Future events...</option>
                </select>
                <span class="badge">Future</span>
            </div>
            <div>
                <label for="pastSelect" class="sr-only">Past</label>
                <select id="pastSelect">
                    <option value="">Past events...</option>
                </select>
                <span class="badge past">Past</span>
            </div>
            <div>
                <label for="stopsSelect" class="sr-only">Nearest Bus Stops</label>
                <select id="stopsSelect">
                    <option value="">Nearest Bus Stops...</option>
                </select>
            </div>
        </div>

        <div class="map-container" id="map">
            <div id="leafletMap"></div>
            <div class="map-loading" id="mapLoading">Loading mapâ€¦</div>
            <div class="magnifier" id="magnifier"></div>
            <div class="map-brand"><img src="espresso.png" alt="Espresso logo"><span>Espresso</span></div>
        </div>

        <div class="events-list" id="eventsList"></div>
        <div class="event-details" id="eventDetails"></div>
    </div>
    
    <footer>
        <p>Espresso World Map | Interactive Event Tracker</p>
    </footer>

    <script>
        // Event data with coordinates
        const events = [
            { name: 'Seoul, South Korea', lat: 37.5665, lng: 126.9780, type: 'upcoming', date: 'October 2023', desc: 'Join us for an exciting event in the heart of Seoul, where we\'ll explore the latest trends in technology and innovation.' },
            { name: 'Buenos Aires, Argentina', lat: -34.6037, lng: -58.3816, type: 'upcoming', date: 'November 2023', desc: 'Experience the vibrant culture of Buenos Aires while networking with industry leaders and innovators.' },
            { name: 'Denver, USA', lat: 39.7392, lng: -104.9903, type: 'past', date: 'June 2022', desc: 'Our mountain-high event in Denver brought together thought leaders from across the industry.' },
            { name: 'Berlin, Germany', lat: 52.5200, lng: 13.4050, type: 'past', date: 'May 2022', desc: 'An unforgettable event in Europe\'s startup capital, focusing on innovation and collaboration.' },
            { name: 'San Francisco, USA', lat: 37.7749, lng: -122.4194, type: 'past', date: 'April 2022', desc: 'Our tech-focused event in the heart of Silicon Valley explored the future of digital innovation.' },
            { name: 'New York, USA', lat: 40.7128, lng: -74.0060, type: 'past', date: 'March 2022', desc: 'The New York event brought together finance and technology leaders for groundbreaking discussions.' },
            { name: 'Cannes, France', lat: 43.5528, lng: 7.0174, type: 'past', date: 'February 2022', desc: 'We hosted a special event during the famous festival season in the French Riviera.' },
            { name: 'Bangkok, Thailand', lat: 13.7563, lng: 100.5018, type: 'past', date: 'January 2022', desc: 'Our Southeast Asia event showcased emerging technologies in one of the region\'s most vibrant cities.' },
            { name: 'Brussels, Belgium', lat: 50.8503, lng: 4.3517, type: 'past', date: 'December 2021', desc: 'Our European capital event focused on policy and technology intersections.' }
        ];

        const mapContainer = document.getElementById('map');
        const leafletMapEl = document.getElementById('leafletMap');
        const magnifier = document.getElementById('magnifier');

        // Initialize Leaflet map (Google-like UX)
        const map = L.map('leafletMap', { zoomControl: true, attributionControl: false });
        const loadingEl = document.getElementById('mapLoading');
        const tileCandidates = [
            { url:'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', opts:{ maxZoom: 18 } },
            { url:'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', opts:{ maxZoom: 18 } },
            { url:'https://stamen-tiles.a.ssl.fastly.net/terrain/{z}/{x}/{y}.jpg', opts:{ maxZoom: 18 } }
        ];
        let tileIdx = 0; let tileLayer;
        function loadTiles() {
            if (tileLayer) { map.removeLayer(tileLayer); }
            const t = tileCandidates[tileIdx];
            tileLayer = L.tileLayer(t.url, t.opts);
            tileLayer.on('load', () => { loadingEl.style.display = 'none'; });
            tileLayer.on('tileerror', () => {
                tileIdx++;
                if (tileIdx < tileCandidates.length) loadTiles();
            });
            tileLayer.addTo(map);
        }
        loadTiles();
        map.setView([20, 0], 2);
        // Geocoder (search box)
        L.Control.geocoder({ defaultMarkGeocode: false }).on('markgeocode', function(e) {
            const c = e.geocode.center; map.flyTo(c, 14);
        }).addTo(map);
        // Locate (user location)
        const locateBtn = L.control({position:'topleft'});
        locateBtn.onAdd = function(){
            const div = L.DomUtil.create('div','leaflet-bar');
            const a = L.DomUtil.create('a','',div); a.href='#'; a.title='Locate me'; a.innerHTML='ðŸ“'; a.style.textDecoration='none'; a.style.padding='0 6px';
            L.DomEvent.on(a,'click',function(ev){ L.DomEvent.stop(ev); map.locate({setView:true, maxZoom:15}); });
            return div;
        };
        locateBtn.addTo(map);

        // Populate dropdowns
        const futureSelect = document.getElementById('futureSelect');
        const pastSelect = document.getElementById('pastSelect');
        events.filter(e => e.type === 'upcoming').forEach(e => {
            const opt = document.createElement('option');
            opt.value = `${e.lat},${e.lng}`; opt.textContent = `${e.name} â€” ${e.date}`; futureSelect.appendChild(opt);
        });
        events.filter(e => e.type === 'past').forEach(e => {
            const opt = document.createElement('option');
            opt.value = `${e.lat},${e.lng}`; opt.textContent = `${e.name} â€” ${e.date}`; pastSelect.appendChild(opt);
        });
        futureSelect.addEventListener('change', onSelect);
        pastSelect.addEventListener('change', onSelect);
        const stopsSelect = document.getElementById('stopsSelect');
        stopsSelect.addEventListener('change', (e) => {
            const val = e.target.value; if (!val) return; const [lat,lng] = val.split(',').map(parseFloat);
            map.flyTo([lat,lng], 17);
        });

        // Create markers as Leaflet markers with custom divIcons
        const markers = [];
        function createMarker(event) {
            const icon = L.divIcon({
                html: `<div class="marker ${event.type}"><span class="cup">&#9749;</span></div>`,
                className: '',
                iconSize: [20,20],
                iconAnchor: [10, 18]
            });
            const m = L.marker([event.lat, event.lng], { icon }).addTo(map);
            m.bindPopup(`<strong>${event.name}</strong><br>${event.date} â€¢ ${event.type}<br>${event.desc}`);
            markers.push({ lf: m, event });
        }
        events.forEach(createMarker);

        // Move magnifier to a lat/lng
        function moveMagnifierTo(lat, lng) {
            // Fly to street level
            map.flyTo([lat, lng], 15, { duration: 0.9 });
            // Position magnifier over the projected point
            setTimeout(() => {
                const point = map.latLngToContainerPoint([lat, lng]);
                magnifier.style.left = point.x + 'px';
                magnifier.style.top = point.y + 'px';
            }, 400);
            // Load nearby bus stops into dropdown using Overpass
            fetch(`https://overpass-api.de/api/interpreter?data=[out:json];node(around:1200,${lat},${lng})[highway=bus_stop];out;`)
                .then(r=>r.json()).then(json => {
                    stopsSelect.innerHTML = '<option value="">Nearest Bus Stops...</option>';
                    json.elements.slice(0,20).forEach(n => {
                        const name = (n.tags && (n.tags.name || n.tags['name:en'])) || 'Bus Stop';
                        const opt = document.createElement('option');
                        opt.value = `${n.lat},${n.lon}`;
                        opt.textContent = `${name}`;
                        stopsSelect.appendChild(opt);
                    });
                }).catch(()=>{ /* ignore errors silently */ });
        }

        // Initialize magnifier somewhere central
        setTimeout(() => {
            const center = map.getSize();
            magnifier.style.left = (center.x*0.6) + 'px';
            magnifier.style.top = (center.y*0.5) + 'px';
        }, 0);

        function onSelect(e) {
            const value = e.target.value; if (!value) return;
            const [latStr, lngStr] = value.split(',');
            const lat = parseFloat(latStr), lng = parseFloat(lngStr);
            moveMagnifierTo(lat, lng);
            const point = map.latLngToContainerPoint([lat, lng]);
            const m = document.createElement('div');
            m.style.position='absolute'; m.style.left=point.x+'px'; m.style.top=point.y+'px'; m.style.transform='translate(-50%, -50%)';
            m.style.width='14px'; m.style.height='14px'; m.style.border='2px solid #e0c8a9'; m.style.borderRadius='50%'; m.style.boxShadow='0 0 12px rgba(224,200,169,0.7)'; m.style.opacity='0.9';
            mapContainer.appendChild(m);
            setTimeout(()=>{ m.style.transition='all 0.6s ease'; m.style.opacity='0'; m.style.transform='translate(-50%, -50%) scale(2)'; }, 20);
            setTimeout(()=>{ m.remove(); }, 800);
        }

        // On resize, reposition markers and magnifier
        window.addEventListener('resize', () => { map.invalidateSize(); });
        map.on('move', () => {
            // keep magnifier centered above the last set position visually during move
            // no-op; Leaflet updates tiles beneath
        });

        // Build concise clickable event list
        const listEl = document.getElementById('eventsList');
        const detailsEl = document.getElementById('eventDetails');
        events.forEach((e, idx) => {
            const item = document.createElement('div');
            item.className = 'event-item';
            item.innerHTML = `<i class="fas fa-location-dot"></i><span>${e.name}</span><span class="tag">${e.type === 'upcoming' ? 'Upcoming' : 'Past'}</span>`;
            item.addEventListener('click', () => {
                document.querySelectorAll('.event-item').forEach(i=>i.classList.remove('active'));
                item.classList.add('active');
                detailsEl.style.display = 'block';
                detailsEl.innerHTML = `<h3>${e.name}</h3><div class="date">${e.date} â€¢ ${e.type}</div><div>${e.desc}</div>`;
                moveMagnifierTo(e.lat, e.lng);
            });
            listEl.appendChild(item);
        });
    </script>
</body>
</html>
